<!DOCTYPE html>
<html>
<head>
    <title>Violation Count Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .pass { color: #10b981; }
        .fail { color: #ef4444; }
        .warning { color: #f59e0b; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
    </style>
</head>
<body>
    <h1>üîç Violation Count Display Diagnostic</h1>
    <p>This tool tests why the violation button isn't showing on your production server.</p>
    
    <button onclick="runTests()">‚ñ∂Ô∏è Run Tests</button>
    
    <div id="results"></div>

    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>‚è≥ Running tests...</p>';
            
            let html = '';
            
            // Test 1: Check if API returns violation_count
            html += '<div class="test"><h3>Test 1: API Response Check</h3>';
            try {
                const response = await fetch('/api/vehicles-search', { credentials: 'include' });
                const data = await response.json();
                
                if (data.vehicles && data.vehicles.length > 0) {
                    const firstVehicle = data.vehicles[0];
                    const hasField = 'violation_count' in firstVehicle;
                    const fieldValue = firstVehicle.violation_count;
                    const fieldType = typeof fieldValue;
                    
                    html += hasField 
                        ? '<p class="pass">‚úÖ API returns violation_count field</p>'
                        : '<p class="fail">‚ùå violation_count field is MISSING from API response</p>';
                    
                    html += `<p>Field value: <code>${fieldValue}</code></p>`;
                    html += `<p>Field type: <code>${fieldType}</code></p>`;
                    
                    if (fieldType !== 'number') {
                        html += '<p class="warning">‚ö†Ô∏è WARNING: violation_count should be a number, but it\'s a ' + fieldType + '</p>';
                    }
                    
                    html += '<p><strong>First vehicle data:</strong></p>';
                    html += '<pre>' + JSON.stringify(firstVehicle, null, 2) + '</pre>';
                } else {
                    html += '<p class="warning">‚ö†Ô∏è No vehicles returned from API</p>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                html += '<p class="fail">‚ùå API request failed: ' + error.message + '</p>';
            }
            html += '</div>';
            
            // Test 2: Test the button rendering logic
            html += '<div class="test"><h3>Test 2: Button Rendering Logic</h3>';
            
            const testVehicles = [
                { id: '1', plate_number: 'TEST-001', violation_count: 0 },
                { id: '2', plate_number: 'TEST-002', violation_count: 3 },
                { id: '3', plate_number: 'TEST-003', violation_count: '5' }, // String test
            ];
            
            testVehicles.forEach(vehicle => {
                const violationCount = parseInt(vehicle.violation_count) || 0;
                const shouldShow = violationCount > 0;
                const buttonHTML = violationCount > 0 ? `
                    <button class="btn btn-small btn-violations">
                        *Violations Exist (${violationCount})
                    </button>
                ` : '';
                
                html += `<p>Vehicle ${vehicle.plate_number}: count=${vehicle.violation_count} (type: ${typeof vehicle.violation_count})</p>`;
                html += `<p style="margin-left: 20px;">‚Üí parseInt result: ${violationCount}</p>`;
                html += `<p style="margin-left: 20px;">‚Üí Should show button? ${shouldShow ? '<span class="pass">YES</span>' : '<span class="warning">NO</span>'}</p>`;
                html += `<p style="margin-left: 20px;">‚Üí Button HTML: ${buttonHTML ? '<span class="pass">Generated</span>' : '<span class="warning">Empty</span>'}</p>`;
            });
            
            html += '</div>';
            
            // Test 3: Check if app.js is the latest version
            html += '<div class="test"><h3>Test 3: JavaScript Version Check</h3>';
            html += '<p>Check if your app.js contains the violation count code:</p>';
            html += '<ol>';
            html += '<li>Open <code>/public/assets/app.js</code> in your browser</li>';
            html += '<li>Search for: <code>const violationCount = parseInt(vehicle.violation_count)</code></li>';
            html += '<li>If NOT found ‚Üí <strong class="fail">You need to upload the updated app.js file!</strong></li>';
            html += '<li>If found ‚Üí <strong class="pass">app.js is updated</strong></li>';
            html += '</ol>';
            html += '<p><a href="/public/assets/app.js" target="_blank" style="color: #3b82f6;">‚Üí Open app.js in new tab</a></p>';
            html += '</div>';
            
            // Test 4: Browser cache check
            html += '<div class="test"><h3>Test 4: Browser Cache</h3>';
            html += '<p class="warning">‚ö†Ô∏è Old JavaScript files might be cached by your browser</p>';
            html += '<p><strong>Clear browser cache:</strong></p>';
            html += '<ul>';
            html += '<li>Windows: Press <code>Ctrl + Shift + R</code></li>';
            html += '<li>Mac: Press <code>Cmd + Shift + R</code></li>';
            html += '<li>Or: Right-click ‚Üí Inspect ‚Üí Network tab ‚Üí Check "Disable cache" ‚Üí Reload page</li>';
            html += '</ul>';
            html += '</div>';
            
            // Test 5: Console errors
            html += '<div class="test"><h3>Test 5: JavaScript Errors</h3>';
            html += '<p>Check browser console for JavaScript errors:</p>';
            html += '<ol>';
            html += '<li>Press <code>F12</code> to open DevTools</li>';
            html += '<li>Click <strong>Console</strong> tab</li>';
            html += '<li>Look for any red errors</li>';
            html += '<li>If you see errors related to "showViolationHistory" or "createVehicleCard", screenshot them</li>';
            html += '</ol>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
